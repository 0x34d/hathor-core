# Documentation: https://docs.gitlab.com/ce/ci/yaml/README.html

stages:
  - linters
  - unit-tests

check:
  stage: linters
  image: python:3.6
  allow_failure: yes
  before_script:
    # install pipenv and then all the dependencies
    - pip install pipenv
    # this will install dependencies to the system (not virtualenv), and only consider versions on Pipfile.lock
    - pipenv install --ignore-pipfile --deploy --system --dev
    # generate protobuf files, needed for type checking
    - make protos
  script:
    - make check

unit-tests:
  stage: unit-tests
  image: python:3.6
  before_script:
    - apt update
    - apt install -y graphviz
    - apt install -y librocksdb-dev libsnappy-dev zlib1g-dev libbz2-dev liblz4-dev
    - pip install pipenv
    - pipenv install --ignore-pipfile --deploy --system --dev
    - pip install python-rocksdb==0.7.0
    - make protos
  script:
    - make tests
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
